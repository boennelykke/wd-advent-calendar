import React, { useState, useEffect, useCallback } from 'react';
import { Shield, Bug, RefreshCw, Trophy, AlertTriangle, Clock, Activity, CheckCircle } from 'lucide-react';

// --- Constants & Config ---
const BOARD_SIZE = 10;
const MINE_COUNT = 15;
const COLORS = {
  workdayBlue: '#005cb9',
  workdayOrange: '#e67300',
  bg: '#f0f2f5',
  cardBg: '#ffffff',
  gridHidden: '#e2e8f0',
  gridRevealed: '#f8fafc',
};

// --- Helper Functions ---

// Directions for neighbor checking
const DIRECTIONS = [
  [-1, -1], [-1, 0], [-1, 1],
  [0, -1],           [0, 1],
  [1, -1],  [1, 0],  [1, 1],
];

const createBoard = (size, mines) => {
  // Initialize empty board
  const board = Array(size).fill(null).map(() => Array(size).fill({
    isMine: false,
    isRevealed: false,
    isFlagged: false,
    neighborCount: 0,
  }));

  // Place mines
  let minesPlaced = 0;
  while (minesPlaced < mines) {
    const r = Math.floor(Math.random() * size);
    const c = Math.floor(Math.random() * size);
    if (!board[r][c].isMine) {
      board[r][c] = { ...board[r][c], isMine: true };
      minesPlaced++;
    }
  }

  // Calculate neighbor counts
  for (let r = 0; r < size; r++) {
    for (let c = 0; c < size; c++) {
      if (!board[r][c].isMine) {
        let count = 0;
        DIRECTIONS.forEach(([dr, dc]) => {
          const nr = r + dr;
          const nc = c + dc;
          if (nr >= 0 && nr < size && nc >= 0 && nc < size && board[nr][nc].isMine) {
            count++;
          }
        });
        board[r][c] = { ...board[r][c], neighborCount: count };
      }
    }
  }
  return board;
};

export default function App() {
  const [board, setBoard] = useState([]);
  const [gameState, setGameState] = useState('idle'); // idle, playing, won, lost
  const [flagsUsed, setFlagsUsed] = useState(0);
  const [timeElapsed, setTimeElapsed] = useState(0);
  const [efficiencyScore, setEfficiencyScore] = useState(100);

  // Initialize game on load
  useEffect(() => {
    resetGame();
  }, []);

  // Timer logic
  useEffect(() => {
    let interval;
    if (gameState === 'playing') {
      interval = setInterval(() => {
        setTimeElapsed((prev) => prev + 1);
        // Decrease efficiency score over time to simulate "operational drag"
        setEfficiencyScore((prev) => Math.max(0, prev - 0.1));
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [gameState]);

  const resetGame = () => {
    setBoard(createBoard(BOARD_SIZE, MINE_COUNT));
    setGameState('playing');
    setFlagsUsed(0);
    setTimeElapsed(0);
    setEfficiencyScore(100);
  };

  const handleCellClick = (r, c) => {
    if (gameState !== 'playing' || board[r][c].isFlagged || board[r][c].isRevealed) return;

    const newBoard = [...board.map(row => [...row])];
    const cell = newBoard[r][c];

    if (cell.isMine) {
      // Game Over Logic
      revealAllMines(newBoard);
      setBoard(newBoard);
      setGameState('lost');
    } else {
      // Reveal Logic
      revealCellRecursive(newBoard, r, c);
      setBoard(newBoard);
      checkWinCondition(newBoard);
    }
  };

  const handleRightClick = (e, r, c) => {
    e.preventDefault();
    if (gameState !== 'playing' || board[r][c].isRevealed) return;

    const newBoard = [...board.map(row => [...row])];
    const cell = newBoard[r][c];

    // Toggle Flag
    if (!cell.isFlagged && flagsUsed < MINE_COUNT) {
      cell.isFlagged = true;
      setFlagsUsed(prev => prev + 1);
    } else if (cell.isFlagged) {
      cell.isFlagged = false;
      setFlagsUsed(prev => prev - 1);
    }
    
    setBoard(newBoard);
  };

  const revealCellRecursive = (currentBoard, r, c) => {
    if (r < 0 || r >= BOARD_SIZE || c < 0 || c >= BOARD_SIZE || currentBoard[r][c].isRevealed || currentBoard[r][c].isFlagged) {
      return;
    }

    currentBoard[r][c].isRevealed = true;

    if (currentBoard[r][c].neighborCount === 0) {
      DIRECTIONS.forEach(([dr, dc]) => {
        revealCellRecursive(currentBoard, r + dr, c + dc);
      });
    }
  };

  const revealAllMines = (currentBoard) => {
    for (let r = 0; r < BOARD_SIZE; r++) {
      for (let c = 0; c < BOARD_SIZE; c++) {
        if (currentBoard[r][c].isMine) {
          currentBoard[r][c].isRevealed = true;
        }
      }
    }
  };

  const checkWinCondition = (currentBoard) => {
    let unrevealedSafeCells = 0;
    for (let r = 0; r < BOARD_SIZE; r++) {
      for (let c = 0; c < BOARD_SIZE; c++) {
        if (!currentBoard[r][c].isMine && !currentBoard[r][c].isRevealed) {
          unrevealedSafeCells++;
        }
      }
    }
    if (unrevealedSafeCells === 0) {
      setGameState('won');
    }
  };

  // --- Render Helpers ---

  const getCellContent = (cell) => {
    if (cell.isFlagged) {
      return <Shield className="w-5 h-5 text-blue-600 drop-shadow-sm" fill="#005cb9" />;
    }
    if (!cell.isRevealed) {
      return null;
    }
    if (cell.isMine) {
      return <Bug className="w-6 h-6 text-red-600 animate-pulse" />;
    }
    if (cell.neighborCount > 0) {
      // Workday Brand Colors for numbers
      const colors = [
        '', 
        'text-blue-600',   // 1
        'text-orange-600', // 2
        'text-purple-600', // 3
        'text-indigo-700', // 4
        'text-red-700',    // 5
        'text-teal-700',   // 6
        'text-gray-800',   // 7
        'text-black'       // 8
      ];
      return <span className={`font-bold text-xl ${colors[cell.neighborCount]}`}>{cell.neighborCount}</span>;
    }
    return null;
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 flex flex-col items-center py-8" style={{ fontFamily: "'Archivo', sans-serif" }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&display=swap');
      `}</style>
      
      {/* Header / Nav Bar Look */}
      <div className="w-full max-w-4xl bg-white shadow-sm border-b border-gray-200 px-6 py-4 mb-8 flex justify-between items-center rounded-lg">
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10 bg-blue-700 rounded-lg flex items-center justify-center text-white font-bold text-2xl shadow-md">W</div>
          <div>
            <h1 className="text-xl font-bold text-gray-800 tracking-tight">Workday Bugs</h1>
            <p className="text-xs text-gray-500 font-medium uppercase tracking-wider">Get rid of the bugs!</p>
          </div>
        </div>
        <div className="flex items-center space-x-6 text-sm font-medium">
            <div className="flex flex-col items-end">
                <span className="text-gray-400 text-xs">System Status</span>
                <span className={`flex items-center gap-1 ${gameState === 'lost' ? 'text-red-600' : 'text-green-600'}`}>
                    {gameState === 'playing' && <Activity className="w-4 h-4 animate-pulse" />}
                    {gameState === 'idle' && "Standby"}
                    {gameState === 'playing' && "Operational"}
                    {gameState === 'won' && "Optimized"}
                    {gameState === 'lost' && "Critical Failure"}
                </span>
            </div>
        </div>
      </div>

      {/* Main Game Container */}
      <div className="bg-white p-8 rounded-xl shadow-xl border border-gray-100 max-w-2xl w-full">
        
        {/* Dashboard Metrics */}
        <div className="grid grid-cols-3 gap-4 mb-6">
          <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex flex-col items-center">
            <span className="text-blue-600 text-xs font-bold uppercase tracking-widest mb-1">Legacy Risks</span>
            <span className="text-3xl font-mono font-bold text-blue-800">{MINE_COUNT - flagsUsed}</span>
            <span className="text-xs text-blue-400 mt-1">Systems to Replace</span>
          </div>

          <button 
            onClick={resetGame}
            className="group relative bg-white border-2 border-gray-100 hover:border-blue-500 rounded-lg flex items-center justify-center overflow-hidden transition-all duration-300"
          >
            <div className={`transform transition-transform duration-300 ${gameState === 'playing' ? 'scale-100' : 'scale-90'}`}>
                {gameState === 'playing' && <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center"><Activity className="text-blue-600 w-6 h-6" /></div>}
                {gameState === 'won' && <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"><Trophy className="text-green-600 w-6 h-6" /></div>}
                {gameState === 'lost' && <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center"><AlertTriangle className="text-red-600 w-6 h-6" /></div>}
            </div>
            <div className="absolute inset-x-0 bottom-2 text-xs text-gray-400 font-medium text-center opacity-0 group-hover:opacity-100 transition-opacity">
                RESET
            </div>
          </button>

          <div className="bg-orange-50 p-4 rounded-lg border border-orange-100 flex flex-col items-center">
            <span className="text-orange-600 text-xs font-bold uppercase tracking-widest mb-1">Uptime</span>
            <span className="text-3xl font-mono font-bold text-orange-800">{String(timeElapsed).padStart(3, '0')}</span>
            <span className="text-xs text-orange-400 mt-1">Seconds Elapsed</span>
          </div>
        </div>

        {/* The Grid */}
        <div 
          className="grid gap-1 bg-gray-200 p-1 rounded-lg mx-auto select-none shadow-inner"
          style={{ 
            gridTemplateColumns: `repeat(${BOARD_SIZE}, minmax(0, 1fr))`,
            width: 'fit-content'
          }}
        >
          {board.map((row, r) => (
            row.map((cell, c) => (
              <div
                key={`${r}-${c}`}
                onClick={() => handleCellClick(r, c)}
                onContextMenu={(e) => handleRightClick(e, r, c)}
                className={`
                  w-10 h-10 md:w-12 md:h-12 flex items-center justify-center cursor-pointer transition-all duration-150 text-sm md:text-base rounded-sm
                  ${!cell.isRevealed && !cell.isFlagged ? 'bg-gradient-to-br from-blue-500 to-blue-600 hover:to-blue-500 shadow-sm border-b-4 border-blue-800' : ''}
                  ${cell.isRevealed ? 'bg-white border border-gray-100 shadow-inner' : ''}
                  ${cell.isFlagged ? 'bg-gradient-to-br from-gray-100 to-gray-200 border border-gray-300' : ''}
                  ${cell.isRevealed && cell.isMine ? 'bg-red-50 border-red-200' : ''}
                `}
              >
                {getCellContent(cell)}
              </div>
            ))
          ))}
        </div>

        {/* Footer / Status Message */}
        <div className="mt-6 text-center h-12">
            {gameState === 'playing' && (
                <p className="text-gray-500 text-sm animate-pulse flex items-center justify-center gap-2">
                    <Activity className="w-4 h-4" />
                    Detecting disparate legacy systems...
                </p>
            )}
            {gameState === 'won' && (
                <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg inline-flex items-center gap-2 shadow-sm animate-bounce">
                    <CheckCircle className="w-5 h-5" />
                    <span className="font-bold">Migration Complete!</span> Efficiency Rating: {Math.floor(efficiencyScore)}%
                </div>
            )}
            {gameState === 'lost' && (
                <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-2 rounded-lg inline-flex items-center gap-2 shadow-sm">
                    <AlertTriangle className="w-5 h-5" />
                    <span className="font-bold">System Crash!</span> Legacy bug encountered.
                </div>
            )}
        </div>
      </div>

      <div className="mt-8 text-gray-400 text-xs text-center max-w-md">
        <p>Left Click to integrate module. Right Click to flag legacy risk.</p>
        <p className="mt-2">Enterprise Sweeper v24.2 &copy; 2024</p>
      </div>

    </div>
  );
}
