<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planeter - Solar System Carousel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
        }

        /* Canvas Container */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: grab;
            transition: cursor 0.2s;
        }

        #canvas-container:active {
            cursor: grabbing;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            box-sizing: border-box;
        }

        /* Logo */
        .logo {
            font-family: 'Cinzel Decorative', serif;
            color: #fff;
            font-size: 1.5rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.9;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            pointer-events: auto;
            cursor: pointer;
        }

        /* Dynamic Headline */
        .planet-name-container {
            position: absolute;
            top: 15%; 
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 100%;
            transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Move headline up when focused */
        body.focused .planet-name-container {
            top: 5%;
            left: 15%; /* Shifted further left */
            transform: translateX(-50%) scale(0.7);
            opacity: 0;
            pointer-events: none;
        }

        #planet-name {
            font-family: 'Playfair Display', serif;
            font-size: clamp(3rem, 8vw, 6rem);
            color: #fff;
            margin: 0;
            font-weight: 400;
            letter-spacing: 0.05em;
            text-transform: capitalize;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        #planet-desc {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.5s ease 0.1s;
        }

        .visible {
            opacity: 1 !important;
        }

        /* Info Card (Left Side) */
        #info-card {
            position: absolute;
            top: 50%;
            left: 5%;
            transform: translateY(-50%) translateX(-50px) scale(0.9);
            width: 350px;
            max-width: 80vw;
            
            /* Glassmorphism Defaults */
            background: linear-gradient(rgba(20, 20, 25, 0.9), rgba(20, 20, 25, 0.9)) padding-box,
                        linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.1)) border-box;
            border: 2px solid transparent;
            border-radius: 12px;
            
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 2.5rem;
            color: #fff;
            opacity: 0;
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        body.focused #info-card {
            transform: translateY(-50%) translateX(0) scale(1.2);
            transform-origin: left center;
            opacity: 1;
            pointer-events: auto;
        }

        #info-card h2 {
            font-family: 'Cinzel Decorative', serif;
            margin: 0 0 0.5rem 0;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        #info-card h3 {
            font-family: 'Playfair Display', serif;
            margin: 0 0 1.5rem 0;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }

        #info-card p {
            font-family: 'Lato', sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-family: 'Lato', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 0.2rem;
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            color: #fff;
        }

        /* Back Button */
        #back-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px 20px;
            font-family: 'Lato', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        #back-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: #fff;
        }

        body.focused #back-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* Navigation Arrows Container */
        .nav-container {
            position: absolute;
            bottom: 3rem;
            right: 3rem;
            display: flex;
            gap: 1rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        body.focused .nav-container {
            opacity: 1;
            pointer-events: auto;
        }

        .nav-arrow {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            font-family: 'Cinzel Decorative', serif;
            transition: all 0.2s ease;
        }

        .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            border-color: #fff;
        }

        @media (max-width: 900px) {
            body.focused #info-card {
                transform: translateY(-50%) translateX(0) scale(1.0);
                left: 0;
                width: 100%;
                border-left: none;
                border-right: none;
                border-radius: 0;
            }
            .nav-container {
                bottom: 1rem;
                right: 50%;
                transform: translateX(50%);
            }
        }

        /* Instruction hint */
        .hint {
            text-align: center;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.8rem;
            margin-bottom: 1rem;
            letter-spacing: 0.1em;
            transition: opacity 0.3s;
        }
        
        body.focused .hint {
            opacity: 0;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="logo" onclick="resetView()">Planeter</div>
        
        <div class="planet-name-container">
            <h1 id="planet-name">Earth</h1>
            <div id="planet-desc">The Blue Marble</div>
        </div>

        <!-- Info Card -->
        <div id="info-card">
            <h2 id="card-title">Earth</h2>
            <h3 id="card-subtitle">The Blue Marble</h3>
            <p id="card-desc">Earth is the third planet from the Sun and the only astronomical object known to harbor life. About 29% of Earth's surface is land consisting of continents and islands.</p>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Diameter</span>
                    <span class="stat-value" id="stat-dia">12,742 km</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Day Length</span>
                    <span class="stat-value" id="stat-day">24 Hours</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Year Length</span>
                    <span class="stat-value" id="stat-year">365 Days</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Moons</span>
                    <span class="stat-value" id="stat-moon">1</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-arrow" onclick="navPlanet(-1)">&#8249;</div>
            <div class="nav-arrow" onclick="navPlanet(1)">&#8250;</div>
        </div>

        <button id="back-btn" onclick="resetView()">Back to Orbit (Esc)</button>

        <div class="hint">DRAG TO ROTATE &bull; USE ARROWS &bull; SCROLL TO EXPLORE</div>
    </div>

    <div id="canvas-container"></div>

    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const CAROUSEL_RADIUS = 30; 
        const PLANET_BASE_SIZE = 6; 
        
        // Planet Data 
        // Using highly reliable texture sources to fix issues
        const planetsData = [
            { 
                name: "Mercury", 
                // New distinct texture for Mercury (4k)
                tex: "https://raw.githubusercontent.com/turban/webgl-earth/master/images/mercury-4k.jpg", 
                scale: 0.8, 
                desc: "The Swift Planet",
                glowColor: "#aaaaaa",
                details: "Mercury is the smallest planet in the Solar System and the closest to the Sun. Its orbit around the Sun takes 87.97 Earth days, the shortest of all the Sun's planets.",
                stats: { dia: "4,879 km", day: "59 Earth Days", year: "88 Earth Days", moons: "0" }
            },
            { 
                name: "Venus", 
                tex: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Venus-real_color.jpg/1024px-Venus-real_color.jpg", 
                scale: 0.65, 
                desc: "The Morning Star",
                glowColor: "#e3bb76",
                details: "Venus is the second planet from the Sun. It has the densest atmosphere of the four terrestrial planets, consisting mainly of carbon dioxide.",
                stats: { dia: "12,104 km", day: "243 Earth Days", year: "225 Earth Days", moons: "0" }
            },
            { 
                name: "Earth", 
                // High Quality 4K Blue Marble texture
                tex: "https://raw.githubusercontent.com/turban/webgl-earth/master/images/2_no_clouds_4k.jpg",
                cloudTex: "https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png", 
                scale: 1.0, 
                desc: "The Blue Marble",
                glowColor: "#4466cc",
                details: "Earth is the third planet from the Sun and the only astronomical object known to harbor life. About 29% of Earth's surface is land consisting of continents and islands.",
                stats: { dia: "12,742 km", day: "24 Hours", year: "365 Days", moons: "1" }
            },
            { 
                name: "Mars", 
                tex: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/OSIRIS_Mars_true_color.jpg/1024px-OSIRIS_Mars_true_color.jpg", 
                scale: 0.85, 
                desc: "The Red Planet",
                glowColor: "#dd4422",
                details: "Mars is the fourth planet from the Sun and the second-smallest planet in the Solar System. It is often referred to as the 'Red Planet' because of reddish iron oxide.",
                stats: { dia: "6,779 km", day: "24h 37m", year: "687 Earth Days", moons: "2" }
            },
            { 
                name: "Jupiter", 
                tex: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Jupiter.jpg/1024px-Jupiter.jpg", 
                scale: 1.4, 
                desc: "The Gas Giant",
                glowColor: "#c88b3a",
                details: "Jupiter is the largest planet in the Solar System. It is a gas giant with a mass one-thousandth that of the Sun, but two-and-a-half times that of all the other planets combined.",
                stats: { dia: "139,820 km", day: "9h 56m", year: "12 Years", moons: "79" }
            }, 
            { 
                name: "Saturn", 
                tex: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/Saturn_%28planet%29_large.jpg/1024px-Saturn_%28planet%29_large.jpg",
                scale: 1.25, 
                desc: "The Ringed Jewel",
                type: 'ringed',
                glowColor: "#ead6b8",
                details: "Saturn is the sixth planet from the Sun and the second-largest in the Solar System, after Jupiter. It is a gas giant with an average radius of about nine and a half times that of Earth.",
                stats: { dia: "116,460 km", day: "10h 42m", year: "29 Years", moons: "82" }
            },
            { 
                name: "Uranus", 
                tex: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Uranus2.jpg/1024px-Uranus2.jpg", 
                scale: 1.1, 
                desc: "The Ice Giant",
                glowColor: "#96dedf",
                details: "Uranus is the seventh planet from the Sun. Its name is a reference to the Greek god of the sky, Uranus, who, according to Greek mythology, was the great-grandfather of Ares.",
                stats: { dia: "50,724 km", day: "17h 14m", year: "84 Years", moons: "27" }
            },
            { 
                name: "Neptune", 
                tex: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Neptune_Full.jpg/1024px-Neptune_Full.jpg", 
                scale: 1.1, 
                desc: "The Windy Planet",
                glowColor: "#4455ee",
                details: "Neptune is the eighth and farthest-known Solar planet from the Sun. In the Solar System, it is the fourth-largest planet by diameter, the third-most-massive planet, and the densest giant planet.",
                stats: { dia: "49,244 km", day: "16h 6m", year: "165 Years", moons: "14" }
            }
        ];

        // --- 2. GLOW TEXTURE GENERATOR ---
        function createGlowTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.4)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 128, 128);
            return new THREE.CanvasTexture(canvas);
        }
        
        const glowTexture = createGlowTexture();


        // --- 3. THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        // Camera Setup
        // Default View State
        const defaultCameraPos = new THREE.Vector3(0, 2, 45);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.copy(defaultCameraPos);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Raycaster for clicks
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
        scene.add(ambientLight);

        const mainLight = new THREE.PointLight(0xffffff, 2.5, 150);
        mainLight.position.set(0, 10, 40);
        scene.add(mainLight);

        const rimLight = new THREE.DirectionalLight(0x4455ff, 1.0);
        rimLight.position.set(20, -10, -30);
        scene.add(rimLight);

        // --- 4. BUILD CAROUSEL ---
        const carouselGroup = new THREE.Group();
        scene.add(carouselGroup);

        const planetMeshes = [];
        const sphereGeo = new THREE.SphereGeometry(1, 64, 64);
        const textureLoader = new THREE.TextureLoader();

        // --- SKY SPHERE BACKGROUND ---
        // Robust background using a large sphere with BackSide
        const skyGeo = new THREE.SphereGeometry(500, 64, 64);
        const skyMat = new THREE.MeshBasicMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/stars_milky_way.jpg'),
            side: THREE.BackSide,
            color: 0xaaaaaa // Dim it slightly
        });
        const sky = new THREE.Mesh(skyGeo, skyMat);
        scene.add(sky);


        function loadPlanetTexture(url, color, material) {
            textureLoader.load(url, 
                (texture) => {
                    material.map = texture;
                    material.needsUpdate = true;
                },
                undefined,
                (err) => {
                    console.log(`Failed to load: ${url}`);
                    material.color.set(color);
                }
            );
        }

        const totalPlanets = planetsData.length;
        const angleStep = (Math.PI * 2) / totalPlanets;
        const earthIndex = planetsData.findIndex(p => p.name === 'Earth');
        const angleOffset = - (earthIndex * angleStep);

        planetsData.forEach((data, index) => {
            const angle = (index * angleStep);
            
            const mat = new THREE.MeshStandardMaterial({
                roughness: 0.6,
                metalness: 0.1,
                color: 0xffffff 
            });

            loadPlanetTexture(data.tex, data.glowColor, mat);

            const mesh = new THREE.Mesh(sphereGeo, mat);
            
            mesh.position.x = Math.sin(angle) * CAROUSEL_RADIUS;
            mesh.position.z = Math.cos(angle) * CAROUSEL_RADIUS;
            mesh.scale.setScalar(PLANET_BASE_SIZE * data.scale);

            // Special Case: Earth Clouds
            if (data.name === "Earth" && data.cloudTex) {
                const cloudGeo = new THREE.SphereGeometry(1.02, 64, 64);
                const cloudMat = new THREE.MeshPhongMaterial({
                    map: textureLoader.load(data.cloudTex),
                    transparent: true,
                    opacity: 0.8,
                    side: THREE.DoubleSide,
                    blending: THREE.NormalBlending,
                    depthWrite: false
                });
                const clouds = new THREE.Mesh(cloudGeo, cloudMat);
                mesh.add(clouds);
                mesh.userData.clouds = clouds;
            }

            // Special Case: Saturn Rings
            if (data.type === 'ringed') {
                const ringGeo = new THREE.RingGeometry(1.4, 2.2, 64);
                const ringMat = new THREE.MeshStandardMaterial({ 
                    color: 0xC5AB85, 
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.8
                });
                
                const pos = ringGeo.attributes.position;
                const v3 = new THREE.Vector3();
                for (let i = 0; i < pos.count; i++){
                    v3.fromBufferAttribute(pos, i);
                    ringGeo.attributes.uv.setXY(i, v3.length() < 1.8 ? 0 : 1, 1);
                }

                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.rotation.x = Math.PI / 2 + 0.2;
                mesh.add(ring);
            }

            // Glow Sprite
            const spriteMat = new THREE.SpriteMaterial({ 
                map: glowTexture, 
                color: data.glowColor, 
                transparent: true, 
                opacity: 0.5,
                blending: THREE.AdditiveBlending
            });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.scale.set(3, 3, 1); 
            sprite.position.z = -0.2; 
            mesh.add(sprite);

            // Metadata for raycasting
            mesh.userData = { 
                isPlanet: true,
                index: index,
                name: data.name, 
                desc: data.desc,
                details: data.details,
                stats: data.stats,
                glowColor: data.glowColor,
                angle: angle
            };
            
            mesh.rotation.z = 0.15; 

            carouselGroup.add(mesh);
            planetMeshes.push(mesh);
        });

        // Initial Rotation
        let targetRotation = angleOffset;
        carouselGroup.rotation.y = targetRotation;

        // --- 6. LOGIC & INTERACTION ---
        
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let mouseXNormalized = 0;
        let mouseYNormalized = 0;
        
        // VIEW STATE: 'orbit' or 'focused'
        let viewState = 'orbit'; 
        let currentActiveName = "Earth";
        let currentFocusedIndex = -1;
        let currentActiveIndex = earthIndex; // Track valid index in orbit mode

        // UI Elements
        const nameEl = document.getElementById('planet-name');
        const descEl = document.getElementById('planet-desc');
        const infoCard = document.getElementById('info-card');
        const cardTitle = document.getElementById('card-title');
        const cardSubtitle = document.getElementById('card-subtitle');
        const cardDesc = document.getElementById('card-desc');
        const statDia = document.getElementById('stat-dia');
        const statDay = document.getElementById('stat-day');
        const statYear = document.getElementById('stat-year');
        const statMoon = document.getElementById('stat-moon');

        // Helper to add transparency to hex color
        function hexToRgba(hex, alpha) {
            let r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        // Initialize Earth Card Style
        const earthData = planetsData.find(p => p.name === "Earth");
        if(earthData) {
             infoCard.style.background = `
                linear-gradient(rgba(20, 20, 25, 0.9), rgba(20, 20, 25, 0.9)) padding-box,
                linear-gradient(135deg, ${hexToRgba(earthData.glowColor, 0.8)}, ${hexToRgba(earthData.glowColor, 0.1)}) border-box
            `;
        }


        setTimeout(() => {
            nameEl.classList.add('visible');
            descEl.classList.add('visible');
        }, 500);

        // Event Listeners
        const canvasContainer = document.getElementById('canvas-container');

        document.addEventListener('mousedown', (e) => {
            if(viewState === 'orbit') {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
                canvasContainer.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            if(viewState === 'orbit') canvasContainer.style.cursor = 'grab';
        });

        document.addEventListener('mousemove', (e) => {
            // Light logic
            mouseXNormalized = (e.clientX / window.innerWidth) * 2 - 1;
            mouseYNormalized = -(e.clientY / window.innerHeight) * 2 + 1;

            if (isDragging && viewState === 'orbit') {
                const deltaMove = { x: e.clientX - previousMousePosition.x };
                targetRotation += deltaMove.x * 0.005;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });

        // Wheel Scroll Navigation
        let scrollTimeout;
        document.addEventListener('wheel', (e) => {
            if (scrollTimeout) return;
            
            // Debounce scroll
            scrollTimeout = setTimeout(() => {
                scrollTimeout = null;
            }, 100);

            const direction = e.deltaY > 0 ? 1 : -1;
            
            if (viewState === 'focused') {
                navPlanet(direction);
            } else {
                // In orbit, scroll just rotates smoothly
                targetRotation += direction * 0.3;
            }
        });

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && viewState === 'focused') {
                resetView();
            }
            if (e.key === 'ArrowRight') {
               navPlanet(1);
            }
            if (e.key === 'ArrowLeft') {
               navPlanet(-1);
            }
        });

        // Click Handler for Zoom/Pan
        document.addEventListener('click', (e) => {
            // Only handle clicks if dragging didn't occur (simple check) and raycast hits a planet
            if (!isDragging && viewState === 'orbit') {
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(planetMeshes);

                if (intersects.length > 0) {
                    const hit = intersects[0].object;
                    // Handle recursive hits (like rings or clouds), find parent mesh
                    let targetMesh = hit;
                    while(!targetMesh.userData.isPlanet && targetMesh.parent) {
                        targetMesh = targetMesh.parent;
                    }

                    if(targetMesh.userData.isPlanet) {
                        focusOnPlanet(targetMesh);
                    }
                }
            }
        });

        function focusOnPlanet(mesh) {
            viewState = 'focused';
            document.body.classList.add('focused');
            canvasContainer.style.cursor = 'default';
            currentFocusedIndex = mesh.userData.index;
            currentActiveIndex = currentFocusedIndex; // Sync active index

            rotateCarouselToPlanet(mesh.userData.angle);

            // 2. Update Card Data
            const data = mesh.userData;
            cardTitle.innerText = data.name;
            cardSubtitle.innerText = data.desc;
            cardDesc.innerText = data.details;
            statDia.innerText = data.stats.dia;
            statDay.innerText = data.stats.day;
            statYear.innerText = data.stats.year;
            statMoon.innerText = data.stats.moons;

            // 3. Update Card Background Color dynamically
            const color = data.glowColor;
            infoCard.style.background = `
                linear-gradient(rgba(20, 20, 25, 0.9), rgba(20, 20, 25, 0.9)) padding-box,
                linear-gradient(135deg, ${hexToRgba(color, 0.8)}, ${hexToRgba(color, 0.1)}) border-box
            `;
        }

        // Helper to rotate carousel
        function rotateCarouselToPlanet(planetAngle) {
             const currentRot = carouselGroup.rotation.y;
             let targetRotY = -planetAngle;
             // Adjust to be close to currentRotation
             while (targetRotY - currentRot > Math.PI) targetRotY -= Math.PI * 2;
             while (targetRotY - currentRot < -Math.PI) targetRotY += Math.PI * 2;
             targetRotation = targetRotY;
        }

        // Navigation for Next/Prev
        window.navPlanet = function(direction) {
            // Determine base index
            let baseIndex = (viewState === 'focused') ? currentFocusedIndex : currentActiveIndex;
            if(baseIndex === -1) baseIndex = 0; // Fallback

            // Calculate next index looping around
            let nextIndex = baseIndex + direction;
            if (nextIndex >= planetMeshes.length) nextIndex = 0;
            if (nextIndex < 0) nextIndex = planetMeshes.length - 1;
            
            // Find the mesh with this index
            const nextMesh = planetMeshes.find(m => m.userData.index === nextIndex);
            
            if (nextMesh) {
                if (viewState === 'focused') {
                    focusOnPlanet(nextMesh);
                } else {
                    // In Orbit mode, just rotate to it without zooming
                    currentActiveIndex = nextIndex;
                    rotateCarouselToPlanet(nextMesh.userData.angle);
                }
            }
        };

        // Exposed global for back button
        window.resetView = function() {
            viewState = 'orbit';
            document.body.classList.remove('focused');
            canvasContainer.style.cursor = 'grab';
            currentFocusedIndex = -1;
        };

        function checkActivePlanet() {
            // Only update text in Orbit mode
            if(viewState !== 'orbit') return;

            // Logic to find closest planet to camera
            // We use simple distance check
            let closestDist = Infinity;
            let closestPlanet = null;

            planetMeshes.forEach(mesh => {
                const worldPos = new THREE.Vector3();
                mesh.getWorldPosition(worldPos);
                const dist = worldPos.distanceTo(camera.position);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestPlanet = mesh;
                }
            });

            if (closestPlanet) {
                // Update global active index so arrows know where to start
                currentActiveIndex = closestPlanet.userData.index;

                if (closestPlanet.userData.name !== currentActiveName) {
                    currentActiveName = closestPlanet.userData.name;
                    nameEl.classList.remove('visible');
                    descEl.classList.remove('visible');

                    setTimeout(() => {
                        nameEl.innerText = closestPlanet.userData.name;
                        descEl.innerText = closestPlanet.userData.desc;
                        nameEl.classList.add('visible');
                        descEl.classList.add('visible');
                    }, 500);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            // --- CAMERA LOGIC ---
            const lerpSpeed = 0.05;
            if (viewState === 'orbit') {
                // Return to center
                camera.position.lerp(defaultCameraPos, lerpSpeed);
                // Allow rotation
                carouselGroup.rotation.y += (targetRotation - carouselGroup.rotation.y) * 0.1;
            } else if (viewState === 'focused') {
                // Zoom in MUCH closer and pan LEFT so planet appears RIGHT
                // Adjusted to x: -12 to be centered slightly right
                // Adjusted z: 35 for good zoom level
                const focusPos = new THREE.Vector3(-12, 1, 35);
                camera.position.lerp(focusPos, lerpSpeed);
                
                // Force carousel to target rotation strictly
                carouselGroup.rotation.y += (targetRotation - carouselGroup.rotation.y) * 0.1;
            }


            // --- LIGHTING ---
            const lightTargetX = mouseXNormalized * 50; 
            const lightTargetY = mouseYNormalized * 40 + 10;
            
            mainLight.position.x += (lightTargetX - mainLight.position.x) * 0.1;
            mainLight.position.y += (lightTargetY - mainLight.position.y) * 0.1;
            mainLight.position.z = 45; 

            // --- OBJECT ANIMATION ---
            planetMeshes.forEach(mesh => {
                mesh.rotation.y += 0.002; 
                if (mesh.userData.clouds) {
                     // Updated Cloud Speed
                     mesh.userData.clouds.rotation.y += 0.0008; 
                }
            });

            // Sky sphere slight rotation
            sky.rotation.y += 0.0001;

            checkActivePlanet();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>